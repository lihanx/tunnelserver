# 代理池 + 隧道服务 (Golang 实现)

## 实现方案

- goroutine-per-connection 的连接处理模式；
- 基于 `select` 和 `time` 的代理池定时更新；
- 基于 `io.Copy` 的零拷贝数据传输；


## 存在的问题

1. 稳定性与客户端直连代理基本相同，但仍有配置运行耗时增加10s左右的情况；
2. “客户端-隧道服务”、“隧道服务-代理” 间的超时关系需要进一步分析；
3. 代理连接未复用；


## 待完成

- [ ] 代理连接池


## 正在进行

- [ ] 使用 OCR处理机测试，配置耗时增加似乎和OCR处理机带宽情况有关，更换 128.141 测试机进行测试；





## 测试记录

| 配置ID | 代理类型     | 任务数 | 平均耗时(s)                           | 失败率(%)                        | 均值                             |
| ------ | ------------ | ------ | ------------------------------------- | -------------------------------- | -------------------------------- |
| 116013 | 直连代理     | 20     | 20.7 / 20.6 / 21.35  / 20.05 / 20.85  | 1.04 / 1.03 / 1.07 / 1.00 / 1.04 | 20.71s / 1.04%                   |
|        |              | 50     | 23.7 / 22.75 / 23.55 / 26.35 / 22.5   | 0.48 / 0.46 / 0.47 / 0.53 / 0.45 | 23.77s / 0.48%                   |
|        |              | 100    | 25.95 / 30.45 / 28.4 / 25.2 / 25.55   | 0.26 / 0.30 / 0.28 / 0.25 / 0.26 | 27.11s / 0.27%                   |
| 116013 | 隧道代理服务 | 20     | 28.75 / 24.8 / 21.6 / 23.3 / 27.3     | 1.43 / 1.24 / 1.08 / 1.17 / 1.37 | 25.15s / 1.26% (+4.44s / +0.22%) |
|        |              | 50     | 30.35 / 33.35 / 33.75 / 34.45 / 34.75 | 0.61 / 0.67 / 0.68 / 0.69 / 0.70 | 33.33s / 0.67% (+9.56s / +0.19%) |
|        |              | 100    | 33.85 / 34.85 / 35.9 / 33.8 / 35.2    | 0.34 / 0.35 / 0.36 / 0.34 / 0.35 | 34.72s / 0.35% (+7.61s / +0.08%) |

> 1. 测试环境 : 192.168.128.141 测试机
> 2. 网站： 抖音
> 3. 测试 5 次，计算平均值；
> 4. 失败率中包含反爬导致的空数据，可参考对比增量；



## 结论



直连代理时，TCP 链接和传输阶段的超时重试，会计算在用户设置的超时时间内；

连接隧道代理服务后，爬虫与隧道服务的连接总是成功的，但隧道服务与第三方代理的连接会产生超时重试，导致最终爬虫的运行时间，大于设置的超时时间。